// Generated by BAML - do not edit
// swift-format-ignore-file

import Foundation
import SWAML

/// Global BAML client instance
/// Configure with environment variables or call `Baml.configure()` before use
public enum Baml {
    private static var _client: BamlAsyncClient?
    private static var _runtime: BamlRuntime?
    private static let lock = NSLock()

    /// The shared async client instance
    public static var client: BamlAsyncClient {
        get async {
            lock.lock()
            defer { lock.unlock() }

            if _client == nil {
                await configure()
            }
            return _client!
        }
    }

    /// Configure the BAML runtime
    /// You must call this with a runtime or registry that has API keys configured
    /// Example:
    /// ```
    /// let registry = ClientRegistry()
    /// await registry.register(
    ///     name: "default",
    ///     provider: .openAI(apiKey: apiKey),
    ///     model: "gpt-4",
    ///     isDefault: true
    /// )
    /// Baml.configure(clientRegistry: registry)
    /// ```
    public static func configure() async {
        fatalError("Baml.configure() requires API keys. Use Baml.configure(runtime:) or Baml.configure(clientRegistry:) instead.")
    }

    /// Configure with a custom runtime
    public static func configure(runtime: BamlRuntime) {
        lock.lock()
        _runtime = runtime
        _client = BamlAsyncClient(runtime: runtime)
        lock.unlock()
    }

    /// Configure with a custom client registry
    public static func configure(clientRegistry: ClientRegistry) {
        lock.lock()
        _runtime = BamlRuntime(clientRegistry: clientRegistry)
        _client = BamlAsyncClient(runtime: _runtime!)
        lock.unlock()
    }

    /// Reset the global client (useful for testing)
    public static func reset() {
        lock.lock()
        _client = nil
        _runtime = nil
        lock.unlock()
    }
}

// MARK: - Environment Configuration

extension Baml {
    /// Get an API key from environment variables
    public static func envApiKey(_ name: String) -> String? {
        ProcessInfo.processInfo.environment[name]
    }

    /// Get a required API key, throwing if not found
    public static func requireEnvApiKey(_ name: String) throws -> String {
        guard let key = envApiKey(name) else {
            throw BamlError.configurationError("Missing required environment variable: \(name)")
        }
        return key
    }
}

// MARK: - Error Types

/// Errors that can occur during BAML operations
public enum BamlError: Error, LocalizedError {
    case configurationError(String)
    case runtimeError(String)
    case parsingError(String)
    case networkError(Error)

    public var errorDescription: String? {
        switch self {
        case .configurationError(let message):
            return "BAML Configuration Error: \(message)"
        case .runtimeError(let message):
            return "BAML Runtime Error: \(message)"
        case .parsingError(let message):
            return "BAML Parsing Error: \(message)"
        case .networkError(let error):
            return "BAML Network Error: \(error.localizedDescription)"
        }
    }
}
