---
source: baml-runtime/src/control_flow/tests.rs
expression: snapshot_value
input_file: baml-runtime/src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
---
hir: "Some(\n    Block {\n        statements: [\n            DeclareAndAssign {\n                name: \"items\",\n                value: Array(\n                    [\n                        NumericValue(\n                            \"1\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 83,\n                                end: 84,\n                            },\n                        ),\n                        NumericValue(\n                            \"2\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 86,\n                                end: 87,\n                            },\n                        ),\n                        NumericValue(\n                            \"3\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 89,\n                                end: 90,\n                            },\n                        ),\n                        NumericValue(\n                            \"4\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 92,\n                                end: 93,\n                            },\n                        ),\n                        NumericValue(\n                            \"5\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 95,\n                                end: 96,\n                            },\n                        ),\n                    ],\n                    Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                        start: 82,\n                        end: 97,\n                    },\n                ),\n                annotated_type: None,\n                watch: None,\n                span: Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                    start: 70,\n                    end: 99,\n                },\n            },\n            DeclareAndAssign {\n                name: \"result\",\n                value: NumericValue(\n                    \"0\",\n                    Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                        start: 116,\n                        end: 117,\n                    },\n                ),\n                annotated_type: None,\n                watch: None,\n                span: Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                    start: 103,\n                    end: 119,\n                },\n            },\n            HeaderContextEnter(\n                HeaderContext {\n                    level: 1,\n                    title: \"Main Loop\",\n                    span: Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                        start: 124,\n                        end: 138,\n                    },\n                },\n            ),\n            ForLoop {\n                identifier: \"item\",\n                iterator: Identifier(\n                    \"items\",\n                    Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                        start: 160,\n                        end: 165,\n                    },\n                ),\n                block: Block {\n                    statements: [\n                        HeaderContextEnter(\n                            HeaderContext {\n                                level: 1,\n                                title: \"Item Processing\",\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                    start: 177,\n                                    end: 198,\n                                },\n                            },\n                        ),\n                        DeclareAndAssign {\n                            name: \"processed\",\n                            value: BinaryOperation {\n                                left: Identifier(\n                                    \"item\",\n                                    Span {\n                                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                        start: 223,\n                                        end: 227,\n                                    },\n                                ),\n                                operator: Mul,\n                                right: NumericValue(\n                                    \"2\",\n                                    Span {\n                                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                        start: 230,\n                                        end: 231,\n                                    },\n                                ),\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                    start: 223,\n                                    end: 231,\n                                },\n                            },\n                            annotated_type: None,\n                            watch: None,\n                            span: Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 207,\n                                end: 233,\n                            },\n                        },\n                        HeaderContextEnter(\n                            HeaderContext {\n                                level: 1,\n                                title: \"Accumulation\",\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                    start: 242,\n                                    end: 260,\n                                },\n                            },\n                        ),\n                        DeclareAndAssign {\n                            name: \"result2\",\n                            value: BinaryOperation {\n                                left: Identifier(\n                                    \"result\",\n                                    Span {\n                                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                        start: 283,\n                                        end: 289,\n                                    },\n                                ),\n                                operator: Add,\n                                right: Identifier(\n                                    \"processed\",\n                                    Span {\n                                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                        start: 292,\n                                        end: 301,\n                                    },\n                                ),\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                    start: 283,\n                                    end: 301,\n                                },\n                            },\n                            annotated_type: None,\n                            watch: None,\n                            span: Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 269,\n                                end: 303,\n                            },\n                        },\n                    ],\n                    trailing_expr: Some(\n                        Identifier(\n                            \"result2\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                                start: 312,\n                                end: 319,\n                            },\n                        ),\n                    ),\n                },\n                span: Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                    start: 143,\n                    end: 325,\n                },\n            },\n            HeaderContextEnter(\n                HeaderContext {\n                    level: 1,\n                    title: \"Final Result\",\n                    span: Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                        start: 331,\n                        end: 348,\n                    },\n                },\n            ),\n        ],\n        trailing_expr: Some(\n            Identifier(\n                \"result\",\n                Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/ForLoopWithTopLevelHeader.baml\", contents: ... },\n                    start: 353,\n                    end: 359,\n                },\n            ),\n        ),\n    },\n)"
expr:
  nodes:
    "0":
      label: ForLoopWithTopLevelHeader
      log_filter_key: "ForLoopWithTopLevelHeader|root:0"
      node_type: function
      parent: ~
      span:
        file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
        start: 20
        end: 361
    "1":
      label: Main Loop
      log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0"
      node_type: header
      parent: "0"
      span:
        file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
        start: 124
        end: 138
    "2":
      label: for (item in items)
      log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0"
      node_type: loop
      parent: "1"
      span:
        file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
        start: 143
        end: 325
    "3":
      label: Item Processing
      log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:item-processing:0"
      node_type: header
      parent: "2"
      span:
        file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
        start: 177
        end: 198
    "4":
      label: Accumulation
      log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:accumulation:1"
      node_type: header
      parent: "2"
      span:
        file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
        start: 242
        end: 260
    "5":
      label: Final Result
      log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:final-result:1"
      node_type: header
      parent: "0"
      span:
        file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
        start: 331
        end: 348
  edges:
    "1":
      - "5"
    "3":
      - "4"
mermaid: "flowchart TD\nsubgraph n0[\"0: ForLoopWithTopLevelHeader\"]\n  direction TB\n  subgraph n1[\"1: Main Loop\"]\n    direction TB\n    subgraph n2[\"2: Loop: for (item in items)\"]\n      direction TB\n      n3[\"3: Item Processing\"]\n      n4[\"4: Accumulation\"]\n      n3 --> n4\n    end\n  end\n  n5[\"5: Final Result\"]\n  n1 --> n5\nend\n"
flattening:
  pass1_remove_implicit:
    label: Remove implicit nodes
    expr:
      nodes:
        "0":
          label: ForLoopWithTopLevelHeader
          log_filter_key: "ForLoopWithTopLevelHeader|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 20
            end: 361
        "1":
          label: Main Loop
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 124
            end: 138
        "2":
          label: for (item in items)
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 143
            end: 325
        "3":
          label: Item Processing
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:item-processing:0"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 177
            end: 198
        "4":
          label: Accumulation
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:accumulation:1"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 242
            end: 260
        "5":
          label: Final Result
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:final-result:1"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 331
            end: 348
      edges:
        "1":
          - "5"
        "3":
          - "4"
    json:
      nodes:
        "0":
          label: ForLoopWithTopLevelHeader
          log_filter_key: "ForLoopWithTopLevelHeader|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 20
            end: 361
        "1":
          label: Main Loop
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 124
            end: 138
        "2":
          label: for (item in items)
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 143
            end: 325
        "3":
          label: Item Processing
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:item-processing:0"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 177
            end: 198
        "4":
          label: Accumulation
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:accumulation:1"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 242
            end: 260
        "5":
          label: Final Result
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:final-result:1"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 331
            end: 348
      edges:
        "1":
          - "5"
        "3":
          - "4"
    mermaid: "flowchart TD\nsubgraph n0[\"0: ForLoopWithTopLevelHeader\"]\n  direction TB\n  subgraph n1[\"1: Main Loop\"]\n    direction TB\n    subgraph n2[\"2: Loop: for (item in items)\"]\n      direction TB\n      n3[\"3: Item Processing\"]\n      n4[\"4: Accumulation\"]\n      n3 --> n4\n    end\n  end\n  n5[\"5: Final Result\"]\n  n1 --> n5\nend\n"
  pass2_hoist_branch_arms:
    label: Hoist branch arms
    expr:
      nodes:
        "0":
          label: ForLoopWithTopLevelHeader
          log_filter_key: "ForLoopWithTopLevelHeader|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 20
            end: 361
        "1":
          label: Main Loop
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 124
            end: 138
        "2":
          label: for (item in items)
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 143
            end: 325
        "3":
          label: Item Processing
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:item-processing:0"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 177
            end: 198
        "4":
          label: Accumulation
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:accumulation:1"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 242
            end: 260
        "5":
          label: Final Result
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:final-result:1"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 331
            end: 348
      edges:
        "1":
          - "5"
        "3":
          - "4"
    json:
      nodes:
        "0":
          label: ForLoopWithTopLevelHeader
          log_filter_key: "ForLoopWithTopLevelHeader|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 20
            end: 361
        "1":
          label: Main Loop
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 124
            end: 138
        "2":
          label: for (item in items)
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 143
            end: 325
        "3":
          label: Item Processing
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:item-processing:0"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 177
            end: 198
        "4":
          label: Accumulation
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:accumulation:1"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 242
            end: 260
        "5":
          label: Final Result
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:final-result:1"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 331
            end: 348
      edges:
        "1":
          - "5"
        "3":
          - "4"
    mermaid: "flowchart TD\nsubgraph n0[\"0: ForLoopWithTopLevelHeader\"]\n  direction TB\n  subgraph n1[\"1: Main Loop\"]\n    direction TB\n    subgraph n2[\"2: Loop: for (item in items)\"]\n      direction TB\n      n3[\"3: Item Processing\"]\n      n4[\"4: Accumulation\"]\n      n3 --> n4\n    end\n  end\n  n5[\"5: Final Result\"]\n  n1 --> n5\nend\n"
  pass3_flatten_scopes:
    label: Flatten branch arms & scopes
    expr:
      nodes:
        "0":
          label: ForLoopWithTopLevelHeader
          log_filter_key: "ForLoopWithTopLevelHeader|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 20
            end: 361
        "1":
          label: Main Loop
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 124
            end: 138
        "2":
          label: for (item in items)
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 143
            end: 325
        "3":
          label: Item Processing
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:item-processing:0"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 177
            end: 198
        "4":
          label: Accumulation
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:accumulation:1"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 242
            end: 260
        "5":
          label: Final Result
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:final-result:1"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 331
            end: 348
      edges:
        "1":
          - "5"
        "3":
          - "4"
    json:
      nodes:
        "0":
          label: ForLoopWithTopLevelHeader
          log_filter_key: "ForLoopWithTopLevelHeader|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 20
            end: 361
        "1":
          label: Main Loop
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 124
            end: 138
        "2":
          label: for (item in items)
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 143
            end: 325
        "3":
          label: Item Processing
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:item-processing:0"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 177
            end: 198
        "4":
          label: Accumulation
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:main-loop:0|loop:for-item-in-items:0|hdr:accumulation:1"
          node_type: header
          parent: "2"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 242
            end: 260
        "5":
          label: Final Result
          log_filter_key: "ForLoopWithTopLevelHeader|root:0|hdr:final-result:1"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/ForLoopWithTopLevelHeader.baml
            start: 331
            end: 348
      edges:
        "1":
          - "5"
        "3":
          - "4"
    mermaid: "flowchart TD\nsubgraph n0[\"0: ForLoopWithTopLevelHeader\"]\n  direction TB\n  subgraph n1[\"1: Main Loop\"]\n    direction TB\n    subgraph n2[\"2: Loop: for (item in items)\"]\n      direction TB\n      n3[\"3: Item Processing\"]\n      n4[\"4: Accumulation\"]\n      n3 --> n4\n    end\n  end\n  n5[\"5: Final Result\"]\n  n1 --> n5\nend\n"
