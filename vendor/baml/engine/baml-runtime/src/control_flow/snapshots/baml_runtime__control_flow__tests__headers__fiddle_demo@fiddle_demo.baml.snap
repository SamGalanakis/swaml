---
source: baml-runtime/src/control_flow/tests.rs
expression: snapshot_value
input_file: baml-runtime/src/control_flow/testdata/fiddle_demo.baml
---
hir: "Some(\n    Block {\n        statements: [\n            HeaderContextEnter(\n                HeaderContext {\n                    level: 1,\n                    title: \"Check\",\n                    span: Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                        start: 324,\n                        end: 333,\n                    },\n                },\n            ),\n            DeclareAndAssign {\n                name: \"result\",\n                value: If {\n                    condition: Identifier(\n                        \"flag\",\n                        Span {\n                            file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                            start: 353,\n                            end: 357,\n                        },\n                    ),\n                    if_branch: Block(\n                        Block {\n                            statements: [],\n                            trailing_expr: Some(\n                                StringValue(\n                                    \"then-branch\",\n                                    Span {\n                                        file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                        start: 365,\n                                        end: 378,\n                                    },\n                                ),\n                            ),\n                        },\n                        Span {\n                            file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                            start: 359,\n                            end: 382,\n                        },\n                    ),\n                    else_branch: Some(\n                        Block(\n                            Block {\n                                statements: [],\n                                trailing_expr: Some(\n                                    StringValue(\n                                        \"else-branch\",\n                                        Span {\n                                            file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                            start: 394,\n                                            end: 407,\n                                        },\n                                    ),\n                                ),\n                            },\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                start: 388,\n                                end: 411,\n                            },\n                        ),\n                    ),\n                    span: Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                        start: 349,\n                        end: 411,\n                    },\n                },\n                annotated_type: None,\n                watch: None,\n                span: Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                    start: 336,\n                    end: 413,\n                },\n            },\n            DeclareAndAssign {\n                name: \"tagged\",\n                value: StringValue(\n                    \"before\",\n                    Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                        start: 435,\n                        end: 443,\n                    },\n                ),\n                annotated_type: None,\n                watch: Some(\n                    WatchSpec {\n                        when: Auto,\n                        name: \"tagged\",\n                        span: Span {\n                            file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                            start: 416,\n                            end: 445,\n                        },\n                    },\n                ),\n                span: Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                    start: 416,\n                    end: 445,\n                },\n            },\n            ForLoop {\n                identifier: \"item\",\n                iterator: Array(\n                    [\n                        StringValue(\n                            \"lorem\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                start: 473,\n                                end: 480,\n                            },\n                        ),\n                        StringValue(\n                            \"ipsum\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                start: 486,\n                                end: 493,\n                            },\n                        ),\n                        StringValue(\n                            \"dolor\",\n                            Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                start: 499,\n                                end: 506,\n                            },\n                        ),\n                    ],\n                    Span {\n                        file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                        start: 467,\n                        end: 510,\n                    },\n                ),\n                block: Block {\n                    statements: [\n                        HeaderContextEnter(\n                            HeaderContext {\n                                level: 1,\n                                title: \"Extract1\",\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                    start: 518,\n                                    end: 530,\n                                },\n                            },\n                        ),\n                        Semicolon {\n                            expr: Call {\n                                function: Identifier(\n                                    \"LlmEcho\",\n                                    Span {\n                                        file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                        start: 535,\n                                        end: 542,\n                                    },\n                                ),\n                                type_args: [],\n                                args: [\n                                    Identifier(\n                                        \"item\",\n                                        Span {\n                                            file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                            start: 543,\n                                            end: 547,\n                                        },\n                                    ),\n                                ],\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                    start: 535,\n                                    end: 548,\n                                },\n                            },\n                            span: Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                start: 535,\n                                end: 550,\n                            },\n                        },\n                        Assign {\n                            left: Identifier(\n                                \"tagged\",\n                                Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                    start: 555,\n                                    end: 561,\n                                },\n                            ),\n                            value: Identifier(\n                                \"item\",\n                                Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                    start: 564,\n                                    end: 568,\n                                },\n                            ),\n                            span: Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                start: 555,\n                                end: 570,\n                            },\n                        },\n                        HeaderContextEnter(\n                            HeaderContext {\n                                level: 1,\n                                title: \"Extract2\",\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                    start: 577,\n                                    end: 589,\n                                },\n                            },\n                        ),\n                        Semicolon {\n                            expr: Call {\n                                function: Identifier(\n                                    \"LlmEcho\",\n                                    Span {\n                                        file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                        start: 594,\n                                        end: 601,\n                                    },\n                                ),\n                                type_args: [],\n                                args: [\n                                    Identifier(\n                                        \"item\",\n                                        Span {\n                                            file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                            start: 602,\n                                            end: 606,\n                                        },\n                                    ),\n                                ],\n                                span: Span {\n                                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                    start: 594,\n                                    end: 607,\n                                },\n                            },\n                            span: Span {\n                                file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                                start: 594,\n                                end: 609,\n                            },\n                        },\n                    ],\n                    trailing_expr: None,\n                },\n                span: Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                    start: 450,\n                    end: 612,\n                },\n            },\n        ],\n        trailing_expr: Some(\n            Identifier(\n                \"tagged\",\n                Span {\n                    file: SourceFile { path: \"src/control_flow/testdata/fiddle_demo.baml\", contents: ... },\n                    start: 617,\n                    end: 623,\n                },\n            ),\n        ),\n    },\n)"
expr:
  nodes:
    "0":
      label: fiddle_demo
      log_filter_key: "fiddle_demo|root:0"
      node_type: function
      parent: ~
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 277
        end: 625
    "1":
      label: Check
      log_filter_key: "fiddle_demo|root:0|hdr:check:0"
      node_type: header
      parent: "0"
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 324
        end: 333
    "2":
      label: if (flag)
      log_filter_key: "fiddle_demo|root:0|hdr:check:0|bg:if-flag:0"
      node_type: branch-group
      parent: "1"
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 349
        end: 411
    "3":
      label: if (flag)
      log_filter_key: "fiddle_demo|root:0|hdr:check:0|bg:if-flag:0|arm:if-flag:0"
      node_type: branch-arm
      parent: "2"
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 359
        end: 382
    "4":
      label: else
      log_filter_key: "fiddle_demo|root:0|hdr:check:0|bg:if-flag:0|arm:else:1"
      node_type: branch-arm
      parent: "2"
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 388
        end: 411
    "5":
      label: "for (item in [\"lorem\", \"ipsum\", \"dolor\"])"
      log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0"
      node_type: loop
      parent: "1"
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 450
        end: 612
    "6":
      label: Extract1
      log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract1:0"
      node_type: header
      parent: "5"
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 518
        end: 530
    "7":
      label: Extract2
      log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract2:1"
      node_type: header
      parent: "5"
      span:
        file: src/control_flow/testdata/fiddle_demo.baml
        start: 577
        end: 589
  edges:
    "2":
      - "5"
    "6":
      - "7"
mermaid: "flowchart TD\nsubgraph n0[\"0: fiddle_demo\"]\n  direction TB\n  subgraph n1[\"1: Check\"]\n    direction TB\n    subgraph n2[\"2: BranchGroup: if (flag)\"]\n      direction TB\n      n3[\"3: BranchArm: if (flag)\"]\n      n4[\"4: BranchArm: else\"]\n    end\n    subgraph n5[\"5: Loop: for (item in [lorem, ipsum, dolor])\"]\n      direction TB\n      n6[\"6: Extract1\"]\n      n7[\"7: Extract2\"]\n      n6 --> n7\n    end\n    n2 --> n5\n  end\nend\n"
flattening:
  pass1_remove_implicit:
    label: Remove implicit nodes
    expr:
      nodes:
        "0":
          label: fiddle_demo
          log_filter_key: "fiddle_demo|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 277
            end: 625
        "1":
          label: Check
          log_filter_key: "fiddle_demo|root:0|hdr:check:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 324
            end: 333
        "5":
          label: "for (item in [\"lorem\", \"ipsum\", \"dolor\"])"
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 450
            end: 612
        "6":
          label: Extract1
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract1:0"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 518
            end: 530
        "7":
          label: Extract2
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract2:1"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 577
            end: 589
      edges:
        "6":
          - "7"
    json:
      nodes:
        "0":
          label: fiddle_demo
          log_filter_key: "fiddle_demo|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 277
            end: 625
        "1":
          label: Check
          log_filter_key: "fiddle_demo|root:0|hdr:check:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 324
            end: 333
        "5":
          label: "for (item in [\"lorem\", \"ipsum\", \"dolor\"])"
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 450
            end: 612
        "6":
          label: Extract1
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract1:0"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 518
            end: 530
        "7":
          label: Extract2
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract2:1"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 577
            end: 589
      edges:
        "6":
          - "7"
    mermaid: "flowchart TD\nsubgraph n0[\"0: fiddle_demo\"]\n  direction TB\n  subgraph n1[\"1: Check\"]\n    direction TB\n    subgraph n2[\"5: Loop: for (item in [lorem, ipsum, dolor])\"]\n      direction TB\n      n3[\"6: Extract1\"]\n      n4[\"7: Extract2\"]\n      n3 --> n4\n    end\n  end\nend\n"
  pass2_hoist_branch_arms:
    label: Hoist branch arms
    expr:
      nodes:
        "0":
          label: fiddle_demo
          log_filter_key: "fiddle_demo|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 277
            end: 625
        "1":
          label: Check
          log_filter_key: "fiddle_demo|root:0|hdr:check:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 324
            end: 333
        "5":
          label: "for (item in [\"lorem\", \"ipsum\", \"dolor\"])"
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 450
            end: 612
        "6":
          label: Extract1
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract1:0"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 518
            end: 530
        "7":
          label: Extract2
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract2:1"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 577
            end: 589
      edges:
        "6":
          - "7"
    json:
      nodes:
        "0":
          label: fiddle_demo
          log_filter_key: "fiddle_demo|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 277
            end: 625
        "1":
          label: Check
          log_filter_key: "fiddle_demo|root:0|hdr:check:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 324
            end: 333
        "5":
          label: "for (item in [\"lorem\", \"ipsum\", \"dolor\"])"
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 450
            end: 612
        "6":
          label: Extract1
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract1:0"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 518
            end: 530
        "7":
          label: Extract2
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract2:1"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 577
            end: 589
      edges:
        "6":
          - "7"
    mermaid: "flowchart TD\nsubgraph n0[\"0: fiddle_demo\"]\n  direction TB\n  subgraph n1[\"1: Check\"]\n    direction TB\n    subgraph n2[\"5: Loop: for (item in [lorem, ipsum, dolor])\"]\n      direction TB\n      n3[\"6: Extract1\"]\n      n4[\"7: Extract2\"]\n      n3 --> n4\n    end\n  end\nend\n"
  pass3_flatten_scopes:
    label: Flatten branch arms & scopes
    expr:
      nodes:
        "0":
          label: fiddle_demo
          log_filter_key: "fiddle_demo|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 277
            end: 625
        "1":
          label: Check
          log_filter_key: "fiddle_demo|root:0|hdr:check:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 324
            end: 333
        "5":
          label: "for (item in [\"lorem\", \"ipsum\", \"dolor\"])"
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 450
            end: 612
        "6":
          label: Extract1
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract1:0"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 518
            end: 530
        "7":
          label: Extract2
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract2:1"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 577
            end: 589
      edges:
        "6":
          - "7"
    json:
      nodes:
        "0":
          label: fiddle_demo
          log_filter_key: "fiddle_demo|root:0"
          node_type: function
          parent: ~
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 277
            end: 625
        "1":
          label: Check
          log_filter_key: "fiddle_demo|root:0|hdr:check:0"
          node_type: header
          parent: "0"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 324
            end: 333
        "5":
          label: "for (item in [\"lorem\", \"ipsum\", \"dolor\"])"
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0"
          node_type: loop
          parent: "1"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 450
            end: 612
        "6":
          label: Extract1
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract1:0"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 518
            end: 530
        "7":
          label: Extract2
          log_filter_key: "fiddle_demo|root:0|hdr:check:0|loop:for-item-in-lorem-ipsum-dolor:0|hdr:extract2:1"
          node_type: header
          parent: "5"
          span:
            file: src/control_flow/testdata/fiddle_demo.baml
            start: 577
            end: 589
      edges:
        "6":
          - "7"
    mermaid: "flowchart TD\nsubgraph n0[\"0: fiddle_demo\"]\n  direction TB\n  subgraph n1[\"1: Check\"]\n    direction TB\n    subgraph n2[\"5: Loop: for (item in [lorem, ipsum, dolor])\"]\n      direction TB\n      n3[\"6: Extract1\"]\n      n4[\"7: Extract2\"]\n      n3 --> n4\n    end\n  end\nend\n"
