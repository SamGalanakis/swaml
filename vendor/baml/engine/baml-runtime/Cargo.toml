[package]
edition = "2021"
name = "baml-runtime"
version.workspace = true
authors.workspace = true
description.workspace = true
license-file.workspace = true

[package.metadata.rustflags]
RSTEST_TIMEOUT = "10"

[build-dependencies]
anyhow.workspace = true

[lints.rust]
dead_code = "allow"
elided_named_lifetimes = "deny"
unused_imports = "allow"
unused_variables = "allow"

[lints.clippy]
module_inception = "allow"
result_large_err = "allow"
large_enum_variant = "allow"
type_complexity = "allow"
too_many_arguments = "allow"
arc_with_non_send_sync = "allow"

[dependencies]
anyhow.workspace = true
baml-compiler = { path = "../baml-compiler" }
baml-ids.workspace = true
internal-baml-ast = { path = "../baml-lib/ast" }
internal-baml-diagnostics = { path = "../baml-lib/diagnostics" }
baml-log.workspace = true
baml-viz-events = { path = "../baml-viz-events" }
baml-types.workspace = true
baml-rpc.workspace = true
baml-vm = { path = "../baml-vm" }
base64.workspace = true
bytes.workspace = true
cfg-if.workspace = true
clap.workspace = true
colored.workspace = true
cowstr.workspace = true
dashmap.workspace = true
derive-new.workspace = true
derive_more.workspace = true
dunce = "1.0.4"
either.workspace = true
env_logger.workspace = true
eventsource-stream = "0.2.3"
futures.workspace = true
http.workspace = true
http-body.workspace = true
indexmap.workspace = true
indoc.workspace = true
# instant = "0.1"  # do not use this or wasm-timer - use web-time instead
json_comments = "0.2.2"
jsonish.workspace = true
# SDK generation - optional, not needed for FFI-only builds
generators-lib = { path = "../generators/utils/generators_lib", optional = true }
generators-openapi = { path = "../generators/languages/openapi", optional = true }
internal-llm-client.workspace = true
internal-baml-core.workspace = true
internal-baml-jinja.workspace = true
log.workspace = true
minijinja.workspace = true
pin-project-lite.workspace = true
pretty.workspace = true
percent-encoding = "2.3.1"
regex.workspace = true
reqwest-eventsource = "0.6.0"
scopeguard.workspace = true
secrecy.workspace = true
serde.workspace = true
serde_json.workspace = true
strsim.workspace = true
strum.workspace = true
strum_macros.workspace = true
thiserror.workspace = true
tokio = { version = "1", default-features = false, features = [
  "macros",
  "time",
] }
tokio-stream = "0.1.15"
# NOTE(sam): adding this caused a build error, I suspect because tower uses nightly features or something
# tower = "0.5.0"
uuid.workspace = true
web-time.workspace = true
static_assertions.workspace = true
mime_guess = "=2.0.5"
mime = "0.3.17"

# For tracing
envy = "0.4.2"
chrono = "0.4.38"
stream-cancel = "0.8.2"
async-std = "1.12.0"
fastrand = "2.1.0"
test-log = "0.2.16"
include_dir = "0.7.3"
infer = "0.16.0"
url = "2.5.2"
shell-escape = "0.1.5"
aws-sigv4 = "1.2.2"
aws-credential-types = "1.2.1"
aws-runtime = "1.5.5"
aws-smithy-async = "1.2.1"
aws-smithy-runtime-api = "1.7.0"
aws-smithy-types = "1.2.0"
aws-smithy-runtime = "1.6.0"
enum_dispatch = "0.3.13"
aws-smithy-json = "0.60.7"
pretty_assertions = "1.4.0"
valuable = { version = "0.1.0", features = ["derive"] }
tracing = { version = "0.1.40", features = ["valuable"] }
tracing-log = "0.2.0"
tracing-core = { version = "0.1.31" }
tracing-subscriber = { version = "0.3.18", features = [
  "json",
  "env-filter",
  "valuable",
] }
log-once = "0.4.1"
once_cell.workspace = true
time.workspace = true
tempfile = "3.19.0"
sha2 = "0.10.9"
blake3 = "1.8.2"
flate2 = "1.1.5"
similar = "2.6"


[target.'cfg(target_arch = "wasm32")'.dependencies]
aws-config = { version = "=1.5.3", default-features = false, features = [] }
# You will run into some crypto/install issues with vertex tests if you move further than this due to https://github.com/awslabs/aws-sdk-rust/releases/tag/release-2025-03-11 . The new version uses aws_lc_rs instead of ring.
# but depending on ring and aws_lc_rs leads to issues.
# https://github.com/rustls/rustls/issues/1877
# https://github.com/awslabs/aws-sdk-rust/issues/1263
# same goes for aws-config.
# Potential migration https://docs.aws.amazon.com/sdk-for-rust/latest/dg/http.html#tlsProviders
aws-sdk-bedrockruntime = { version = "=1.106.0", default-features = false, features = [
] }
colored = { version = "2.1.0", default-features = false, features = [
  "no-color",
] }
futures-timer = { version = "3.0.3", features = ["wasm-bindgen"] }
js-sys.workspace = true
reqwest = { version = "0.12.12", features = [
  "stream",
  "json",
  "native-tls-vendored",
  "native-tls-alpn",
] }
#
send_wrapper = { version = "0.6.0", features = ["futures"] }
serde-wasm-bindgen = "0.6.5"
uuid = { workspace = true, features = ["v4", "serde", "js"] }
# WARNING: Do not add serde-serialize feature to wasm-bindgen.
# It may produce a dependency cycle in projects that use wasm and import baml.
wasm-bindgen = "^0.2.74"
wasm-bindgen-futures = "0.4"
web-sys.workspace = true
wasmtimer = "0.4.3"
tokio = { version = "1", features = ["rt", "sync"] }


# MODIFIED for ellie-wrapped-embedded: Split non-wasm deps into iOS-compatible and desktop-only
# iOS builds exclude GCP auth, TUI libs, file watching, and web server components

# Dependencies for all non-wasm targets (including iOS)
[target.'cfg(not(target_arch = "wasm32"))'.dependencies]
aws-config = "=1.5.3"
aws-sdk-bedrockruntime = { version = "=1.106.0", default-features = false, features = [] }
hostname = "0.3.1"
jsonwebtoken = { version = "9.3.0" }
ring = { version = "0.17.4", features = ["std"] }
tokio = { version = "1", features = ["full"] }
reqwest.workspace = true
walkdir = "2.5.0"
which = "6.0.3"
dirs = "5.0"

# Desktop-only dependencies (excluded from iOS builds)
# These include GCP auth, TUI libs, web server, and file watching
[target.'cfg(all(not(target_arch = "wasm32"), not(target_os = "ios")))'.dependencies]
axum = "0.7.5"
axum-extra = { version = "0.9.3", features = ["erased-json", "typed-header"] }
criterion = "0.5.1"
gcp_auth = "0.12.3"
notify-debouncer-full = "0.3.1"
indicatif = "0.17"
junit-report = "0.8.3"
ratatui = "0.29"
unicode-width = "0.1"
supports-color = "3"
crossterm = "0.28"
reedline = "0.37"


[features]
defaults = ["skip-integ-tests", "sdk-generation"]
internal = []
skip-integ-tests = []
# Use the THIR interpreter runtime instead of the VM bytecode runtime
thir-interpreter = []
# SDK generation feature - enables code generation for various languages
# Disable this for FFI-only builds to reduce binary size
sdk-generation = ["generators-lib", "generators-openapi"]
# FFI-only mode - minimal runtime for FFI calls, no SDK generation
ffi-only = []


[dev-dependencies]
assert_cmd = "2"
console_log = "1"
criterion = "0.5.1"
dissimilar = "1.0.4"
expect-test = "1.1.0"
indoc.workspace = true
either = "1.8.1"
rstest = "0.22.0"
wasm-bindgen-test = "0.3.42"
walkdir = "2.5.0"
wasm-logger = "0.2.0"
serial_test = "3.2.0"
console_error_panic_hook = "0.1.7"
insta = { version = "1.43.2", features = ["yaml", "glob"] }
